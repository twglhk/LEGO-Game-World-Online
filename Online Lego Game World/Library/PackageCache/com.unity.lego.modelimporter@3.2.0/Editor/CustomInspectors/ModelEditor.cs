// Copyright (C) LEGO System A/S - All Rights Reserved
// Unauthorized copying of this file, via any medium is strictly prohibited

using UnityEngine;
using UnityEditor;
using System.IO;

namespace LEGOModelImporter
{
    [CustomEditor(typeof(Model))]
    public class ModelEditor : Editor
    {
        Model model;

        protected virtual void OnEnable()
        {
            model = (Model)target;
        }

        public override void OnInspectorGUI()
        {
            serializedObject.Update();

            var doReimport = false;
            string newReimportPath = null;

            GUILayout.Label("Import", EditorStyles.boldLabel);
            if (model.autoGenerated)
            {
                EditorGUILayout.HelpBox("This model was created by brick building. You cannot reimport it.", MessageType.Info);
            }
            else
            {
                EditorGUILayout.LabelField("Pivot", ObjectNames.NicifyVariableName(model.pivot.ToString()));
                EditorGUILayout.LabelField("Relative File Path", model.relativeFilePath, EditorStyles.wordWrappedLabel);
                GUILayout.Space(16);
                EditorGUILayout.LabelField("Absolute File Path", model.absoluteFilePath, EditorStyles.wordWrappedLabel);

                GUILayout.Space(16);

                // Check if part of prefab instance and prevent reimport.
                if (PrefabUtility.IsPartOfAnyPrefab(target))
                {
                    EditorGUILayout.HelpBox("You cannot reimport a prefab instance. Please perform reimporting on the prefab itself.", MessageType.Warning);
                }
                else
                {
                    if (File.Exists(model.relativeFilePath) || File.Exists(model.absoluteFilePath))
                    {
                        doReimport = GUILayout.Button("Reimport");
                    }
                    else
                    {
                        EditorGUILayout.HelpBox("Could not find original file.", MessageType.Warning);
                    }

                    if (GUILayout.Button("Reimport From New File"))
                    {
                        var path = EditorUtility.OpenFilePanelWithFilters("Select model file", "Packages/com.unity.lego.modelimporter/Models", new string[] { "All model files", "ldr,io,lxfml,lxf", "LDraw files", "ldr", "Studio files", "io", "LXFML files", "lxfml", "LXF files", "lxf" });
                        if (path.Length != 0)
                        {
                            newReimportPath = path;
                            doReimport = true;
                        }
                    }
                }
            }

            serializedObject.ApplyModifiedProperties();

            if (doReimport)
            {
                ImportModel.ReimportModel(model, newReimportPath);
            }
        }
    }

}